<div class="candidates-main-container">

  <!-- Header -->
  <div class="candidates-header minimal-header">
    <div class="header-content">
      <h2>Applicants for "{{ jobTitle }}"</h2>
      <p class="total-candidates">Total Candidates: {{ candidates.length }}</p>
    </div>
  </div>

  <!-- Filters -->
<!-- Filters Section -->
<!-- Filters -->
<div class="filter-bar">
  <div class="filter-group">
    <label class="filter-label">Search</label>
    <input type="text" class="search-input" placeholder="Search by name or email..." [(ngModel)]="searchTerm" />
  </div>



  <div class="filter-group">
    <label class="filter-label">Status</label>
    <select class="filter-select" [(ngModel)]="selectedStatus">
      <option value="">All Statuses</option>
      <option value="PENDING">Pending</option>
      <option value="ACCEPTED">Accepted</option>
      <option value="REJECTED">Rejected</option>
    </select>
  </div>

  <div class="filter-group">
    <label class="filter-label">Sort</label>
    <select class="filter-select" [(ngModel)]="selectedSort">
      <option value="score-desc">Highest Match</option>
      <option value="score-asc">Lowest Match</option>
    </select>
  </div>
</div>

  <!-- Table -->
  <div *ngIf="filteredCandidates.length > 0; else noCandidates" class="candidates-table-wrapper">
    <table class="candidates-table">
      <thead>
        <tr>
          <th>Profile</th>
          <th>Full Name</th>
          <th>Email</th>
          <th>Phone</th>
        
          <th>Match %</th>
          <th>CV</th>
          <th>Contact</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let candidate of paginatedCandidates">
          <td>
            <img [src]="candidate.profilePictureUrl || 'assets/FrontOffice/images/default.avif'" class="avatar" alt="Profile" />
          </td>
          <td>{{ candidate.fullName }}</td>
          <td>{{ candidate.email }}</td>
          <td>{{ candidate.phone }}</td>
          
          <td>
            <div class="match-circle-wrapper">
              <svg class="match-progress" viewBox="0 0 36 36">
                <path class="circle-bg" d="M18 2a16 16 0 1 1 0 32 16 16 0 1 1 0-32" />
                <path class="circle-bar"
                      [attr.stroke-dasharray]="'100, 100'"
                      [attr.stroke-dashoffset]="100 - candidate.matchingPercentage"
                      [ngClass]="getMatchClass(candidate.matchingPercentage)"
                      d="M18 2a16 16 0 1 1 0 32 16 16 0 1 1 0-32" />
                <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" class="circle-text">
                  {{ candidate.matchingPercentage }}%
                </text>
              </svg>
              <div class="match-description" [ngClass]="getMatchClass(candidate.matchingPercentage)">
                {{ getMatchLabel(candidate.matchingPercentage) }}
              </div>

              <button class="score-info-btn" (click)="showScoreDetails(candidate)">
                <i class="fas fa-info-circle"></i>
              </button>
            </div>
          </td>
          
          <td class="cv-actions">
            <ng-container *ngIf="candidate.cvUrl; else noCv">
              <button class="cv-btn-table" title="View CV" (click)="previewCv(candidate.cvUrl)">
                <i class="fas fa-eye"></i>
              </button>
              
              <a [href]="candidate.cvUrl" download class="cv-btn-table" title="Download CV">
                <i class="fas fa-download"></i>
              </a>
            </ng-container>
            <ng-template #noCv>
              <span class="no-cv-text">N/A</span>
            </ng-template>
          </td>
          <!-- Inside the table row <tr> for each candidate -->
<td>
  <a
    *ngIf="candidate.userId"
    [routerLink]="['/chat']"
    [queryParams]="{ to: candidate.userId }"
    class="message-btn-table"
    title="Message Candidate"
  >
    <i class="fas fa-comments"></i> Message
  </a>
</td>

          
          <td>
            <div *ngIf="candidate.status === 'ACCEPTED'">
              <div class="status-label accepted">Accepted</div>
              <button class="interview-btn" (click)="openInterviewModal(candidate)">Schedule Interview</button>
            </div>

            <div *ngIf="candidate.status === 'REJECTED'" class="status-label rejected">Rejected</div>

            <div *ngIf="candidate.status !== 'ACCEPTED' && candidate.status !== 'REJECTED'">
              <button class="accept-btn" (click)="acceptApplication(candidate.applicationId)">
                <i class="fas fa-check"></i> Accept
              </button>
              <button class="reject-btn" (click)="rejectApplication(candidate.applicationId)">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Interview Modal -->
    <!-- Interview Modal -->
<div class="modal-backdrop" *ngIf="showInterviewModal">
  <div class="modal">
    <h3>Schedule Interview</h3>

    <div class="modal-field">
      <label for="interview-date">Date & Time</label>
      <input id="interview-date" type="datetime-local" [(ngModel)]="interviewForm.proposedDate" />
    </div>

    <div class="modal-field">
      <label for="interview-location">Location</label>
      <input id="interview-location" type="text" [(ngModel)]="interviewForm.location" placeholder="e.g., Zoom, Office, etc." />
    </div>

    <div class="modal-field">
      <label for="interview-notes">Notes</label>
      <textarea id="interview-notes" rows="4" [(ngModel)]="interviewForm.notes" placeholder="Add any special instructions or context..."></textarea>
    </div>

    <div class="modal-actions">
      <button class="primary-btn" (click)="submitInterview()">Schedule</button>
      <button class="cancel-btn" (click)="closeInterviewModal()">Cancel</button>
    </div>
  </div>
</div>

  </div>

  <!-- No Candidates Template -->
  <ng-template #noCandidates>
    <div class="no-results-artistic">
      <p>No candidates have applied yet for this offer.<br>Share your job offer to attract more talent!</p>
    </div>
  </ng-template>


  <!-- Score Details Modal -->
<!-- Score Details Modal -->
<div class="modal-backdrop" *ngIf="showScorePopup">
  <div class="modal score-modal-clean">
    <h2 class="score-title">Match Overview</h2>

    <div class="score-block">
      <span class="score-label">Overall Score</span>
      <div class="score-value">{{ selectedScore?.matchingPercentage }}%</div>
    </div>

    <div *ngIf="selectedScore?.missingSkills?.length" class="missing-skills-section">
      <span class="score-label">Missing Skills</span>
      <ul class="missing-skill-tags">
        <li *ngFor="let skill of selectedScore.missingSkills" class="tag-chip">
          {{ skill }}
        </li>
      </ul>
    </div>

    <div *ngIf="!selectedScore?.missingSkills?.length" class="no-missing">
      This candidate meets all key requirements.
    </div>

    <div class="modal-actions">
      <button class="close-btn" (click)="closeScorePopup()">Close</button>
    </div>
  </div>
</div>
<div class="modal-backdrop" *ngIf="cvPreviewUrl">
  <div class="modal pdf-preview-modal">
    <iframe [src]="cvPreviewUrl | safeUrl" width="100%" height="600px"></iframe>
    <button class="close-btn" (click)="closeCvPreview()">Close</button>
  </div>
</div>



</div>
